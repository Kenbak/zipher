# Ziphers Wallet - Cursor AI Rules

## Project Context
You are working on **Ziphers**, a Zcash wallet browser extension (Chrome/Brave/Edge).
This is a privacy-focused cryptocurrency wallet similar to Leather (Bitcoin) or Unisat.

## Tech Stack
- React 18 + TypeScript + Vite
- WebZjs (ChainSafe) for Zcash functionality
- Chrome Extension Manifest V3
- Tailwind CSS (CipherScan design system)
- Zustand for state management

## Key Constraints

### Security
1. NEVER store unencrypted seed phrases or private keys
2. ALWAYS use encrypted storage (AES-256-GCM)
3. NEVER log sensitive data (seeds, keys, passwords)
4. ALWAYS validate user inputs (addresses, amounts)
5. Use Content Security Policy (CSP) strictly

### Code Quality
1. TypeScript strict mode enabled
2. No `any` types (use `unknown` if needed)
3. Prefer functional components (hooks)
4. Keep components under 200 lines
5. Extract reusable logic into custom hooks

### Performance
1. Lazy load routes/pages
2. Memoize expensive computations
3. Use React.memo for pure components
4. WebZjs operations in background/workers
5. Debounce user inputs

### UX/UI
1. Follow CipherScan design system colors:
   - cipher-cyan (#00D9FF)
   - cipher-green (#00FF94)
   - cipher-bg (#0A0E17)
   - cipher-surface (#141B2D)
2. Loading states for all async operations
3. Clear error messages (user-friendly)
4. Consistent spacing (4, 8, 16, 24px)
5. Mobile-first (extension popup = 375x600px)

## Code Style

### Component Structure
```typescript
// 1. Imports
import { useState } from 'react';
import { useWallet } from '@/hooks/useWallet';

// 2. Types
interface Props {
  address: string;
}

// 3. Component
export function ComponentName({ address }: Props) {
  // 4. Hooks
  const wallet = useWallet();
  const [state, setState] = useState();

  // 5. Effects
  useEffect(() => {}, []);

  // 6. Handlers
  const handleClick = () => {};

  // 7. Render
  return <div></div>;
}
```

### Naming Conventions
- Components: PascalCase (`SendForm.tsx`)
- Hooks: camelCase with 'use' prefix (`useWallet.ts`)
- Utils: camelCase (`formatZec.ts`)
- Types: PascalCase (`Transaction.ts`)
- Constants: SCREAMING_SNAKE_CASE (`MAX_MEMO_LENGTH`)

### Error Handling
```typescript
try {
  await wallet.send(address, amount);
} catch (error) {
  if (error instanceof InsufficientFundsError) {
    // Handle specific error
  } else {
    // Log and show generic message
    console.error('Send failed:', error);
    showError('Transaction failed. Please try again.');
  }
}
```

## WebZjs Usage

### Initialization (Once!)
```typescript
import initWasm, { initThreadPool } from '@chainsafe/webzjs-wallet';

// Call once on app startup
await initWasm();
await initThreadPool(navigator.hardwareConcurrency || 4);
```

### Wallet Operations
```typescript
// Create wallet
const wallet = new WebWallet("test", LIGHTWALLETD_URL, 1);
await wallet.create_account(seedPhrase, 0, birthdayHeight);

// Get balance
const balance = await wallet.get_balance(0);

// Send transaction
const txid = await wallet.send_transaction(
  0,        // account
  toAddress,
  amount,
  memo
);
```

## API Endpoints

### CipherScan API (Enriched Data)
- `GET /api/tx/:txid` - Transaction details
- `GET /api/address/:address` - Address history
- `GET /api/network/stats` - Network status

### Lightwalletd (Core Wallet)
- Primary: `https://zcash-testnet.chainsafe.dev`
- Backup: `ws://testnet.cipherscan.app:9067`

## Common Patterns

### Zustand Store
```typescript
import { create } from 'zustand';

interface WalletStore {
  isUnlocked: boolean;
  balance: bigint;
  unlock: (password: string) => Promise<void>;
}

export const useWalletStore = create<WalletStore>((set) => ({
  isUnlocked: false,
  balance: 0n,
  unlock: async (password) => {
    // Decrypt and load wallet
    set({ isUnlocked: true });
  },
}));
```

### Custom Hook
```typescript
export function useBalance() {
  const [balance, setBalance] = useState<bigint>(0n);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadBalance();
  }, []);

  async function loadBalance() {
    try {
      const bal = await getWallet().get_balance(0);
      setBalance(bal);
    } catch (error) {
      console.error('Failed to load balance:', error);
    } finally {
      setLoading(false);
    }
  }

  return { balance, loading, refresh: loadBalance };
}
```

### Format ZEC Amount
```typescript
export function formatZec(zatoshis: bigint): string {
  const zec = Number(zatoshis) / 100_000_000;
  return zec.toFixed(8).replace(/\.?0+$/, '');
}

// 12345678 → "0.12345678"
// 100000000 → "1"
// 150000000 → "1.5"
```

## Testing Checklist

Before committing:
- [ ] TypeScript compiles with no errors
- [ ] No console errors in browser
- [ ] Works in Chrome, Brave, Edge
- [ ] Loading states shown for async ops
- [ ] Errors handled gracefully
- [ ] No sensitive data logged
- [ ] Mobile responsive (375px width)

## Links to Check Regularly

- Read `PROJECT.md` for full vision
- Check WebZjs docs: https://chainsafe.github.io/WebZjs/
- Test on: https://testnet.cipherscan.app
- Get testnet ZEC: https://testnet.zecfaucet.com/

## Priorities

1. **Security** > Everything else
2. **User Experience** > Feature count
3. **Code Quality** > Speed of development
4. **Privacy** > Analytics/Tracking

## Remember

- This is a TESTNET wallet initially
- Users' funds depend on this code
- Privacy is the core value proposition
- "Powered by CipherScan" branding
- Open source, auditable, transparent
